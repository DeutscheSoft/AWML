<html>
  <head>
    <script type="module" src="../src/index.js"></script>
    <script type="module">
      import { define, assertEqual, waitForDOMEvent } from './testing.js';

      async function testOpenBehavior(b) {
        if (b.isOpen)
          return;

        const a = await Promise.all([
          waitForDOMEvent(b, 'open'),
          b.whenOpen(),
          waitForDOMEvent(document, 'AWMLBackendRegistered')
        ]);

        assertEqual(b.isOpen, true);

        assertEqual(a[2].detail.backend, b.backend);
        assertEqual(a[2].detail.name, b.name);
      }


      define(async () => {
        const b = document.querySelector('awml-backend');

        // check that attributes and properties work correctly
        assertEqual(b.name, 'foo');
        assertEqual(b.type, 'local');
        assertEqual(b.backend.name, 'foo');
        b.name = 'bar';
        assertEqual(b.backend.name, 'bar');
        b.setAttribute('name', 'flupp');
        assertEqual(b.backend.name, 'flupp');

        await testOpenBehavior(b);

        b.type = null;

        assertEqual(b.isOpen, false);

        const p = testOpenBehavior(b);

        b.type = 'local';

        await p;
      });
    </script>
    <awml-backend name="foo" type="local"></awml-backend>
  </head>
  <body></body>
</html>
